@using TestMudBlazorApplication.Models;

@inject HttpClient _http

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="_newCard.Title" Placeholder="Title" DisableUnderLine="true" Margin="Margin.Dense" Class="mx-2 mt-n2"></MudTextField>
		<MudTextField @bind-Value="_newCard.CardDescription" Placeholder="Description" DisableUnderLine="true" Margin="Margin.Dense" Class="mx-2 mt-n2"></MudTextField>
		<MudTextField @bind-Value="_newCard.CardStatus" Disabled="true" DisableUnderLine="true" Margin="Margin.Dense" Class="mx-2 mt-n2"></MudTextField>
        <MudSelect @ref="_dropdown" Placeholder="Assign user" @bind-Value="_newCard.UserId">
			@foreach (var item in _users)
			{
				<MudSelectItem Value="@item.UserId">@item.Initials</MudSelectItem>
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public string StatusName { get; set; }

    private MudSelect<User> _dropdown;

    protected override async Task OnInitializedAsync()
    {
        _newCard.CardStatus = StatusName;
        _users = await _http.GetFromJsonAsync<List<User>>("http://localhost:5213/api/User");
    }

    public Card _newCard { get; set; } = new Card();
    public List<User> _users { get; set; } = new();

    async void Submit()
    {
        Console.WriteLine("CardId: " + _newCard.CardId);
        if (_newCard.CardId > 0)
        {
            Console.WriteLine("Why is it in here?");
        }
        else
        {
            Console.WriteLine("Adding new card.");
            HttpResponseMessage responseMessage = await _http.PostAsJsonAsync($"http://localhost:5213/api/Card", _newCard);
            if (responseMessage.IsSuccessStatusCode)
            {

                Console.WriteLine("Card added successfully");
                MudDialog.Close(DialogResult.Ok(_newCard));
            }
            else
            {

                Console.WriteLine("Card not added: " + responseMessage.StatusCode.ToString());
            }
        }
        MudDialog.Close(DialogResult.Cancel());
    }
    void Cancel() => MudDialog.Cancel();
}

